general:
  branches:
    ignore:
      - gh-pages
machine:
  timezone: Asia/Tokyo
  node:
    version: 6.5.0
  post:
    - curl -o- -L https://yarnpkg.com/install.sh | bash
    - sudo pip install awscli

dependencies:
  cache_directories:
    - "~/.cache/yarn"

  pre:
    - yarn --version

  override:
    - yarn install
test:
  override:
    - npm run build && npm test
    - npm run hs & npm run e2e-test
    - aws s3 cp $CIRCLE_ARTIFACTS/ s3://circleci-grimoire-e2e/ci/$CIRCLE_PROJECT_REPONAME/$CIRCLE_BUILD_NUM --recursive
    - curl https://grimoire-e2e.herokuapp.com/$CIRCLE_PROJECT_REPONAME/$CIRCLE_PREVIOUS_BUILD_NUM/$CIRCLE_BUILD_NUM
  post:
    -| npm run semantic-release \
        if [test $? -eq 0] then;\
          curl https://preset-updater.herokuapp.com/?repo=preset-basic&repoURL=https://github.com/GrimoireGL/grimoirejs-preset-basic.git&buildNumber=$CIRCLE_BUILD_NUM&currentPkg=grimoirejs-fundamental \
        fi \
        exit 0
